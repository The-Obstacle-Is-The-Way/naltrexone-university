# SPEC-006: Drizzle Schema

**Status:** Ready
**Layer:** Infrastructure (Outermost)
**Dependencies:** None
**Implements:** ADR-001, ADR-002

---

## Objective

Define the database schema (Drizzle + Postgres) that persists our question bank and subscription state.

This spec describes the **requirements and invariants**. The **source of truth** for the schema itself is the code in `db/schema.ts` and the generated SQL in `db/migrations/`.

---

## Source of Truth

- **Schema (SSOT):** `db/schema.ts`
- **Migrations (generated):** `db/migrations/`
- **Canonical schema narrative:** `docs/specs/master_spec.md` (Section 3)

---

## Required Enums

The schema MUST define these Postgres enums (names are part of the contract):

- `question_difficulty`: `easy | medium | hard`
- `question_status`: `draft | published | archived`
- `tag_kind`: `domain | topic | substance | treatment | diagnosis`
- `practice_mode`: `tutor | exam`
- `stripe_subscription_status`: `incomplete | incomplete_expired | trialing | active | past_due | canceled | unpaid | paused`

---

## Required Tables

The schema MUST define these tables (names are part of the contract):

- `users`
- `stripe_customers`
- `stripe_subscriptions`
- `stripe_events` (idempotency)
- `questions`
- `choices`
- `tags`
- `question_tags` (join table)
- `practice_sessions`
- `attempts`
- `bookmarks`

---

## Invariants (Non-Negotiable)

- **UUIDs:** Primary keys are UUIDs with database defaults (not client-generated for MVP).
- **Time zones:** Persist timestamps as `timestamptz` (`timestamp with time zone`).
- **Idempotency:** Stripe webhooks MUST be idempotent via `stripe_events` (see master spec Section 4.4.2).
- **FK integrity:** All foreign keys must be explicit and use `onDelete` behavior as specified in `docs/specs/master_spec.md`.
- **Indexes:** `db/schema.ts` must include the indexes described in master spec Section 3 (query patterns).

---

## Migrations

- The initial migration MUST include:
  - `CREATE EXTENSION IF NOT EXISTS "pgcrypto";`
  - enum creation
  - table creation + indexes

Migrations are generated by `drizzle-kit` and committed to the repo.

---

## Tests

We verify the migration output (not the TypeScript AST) via integration tests:

- `tests/integration/db.integration.test.ts` ensures:
  - `pgcrypto` is enabled
  - required tables exist after migrations run

---

## Definition of Done

- [ ] `db/schema.ts` matches `docs/specs/master_spec.md` Section 3
- [ ] `pnpm db:generate` produces a migration that includes `pgcrypto`
- [ ] `pnpm db:migrate` applies cleanly on a fresh database
- [ ] `pnpm test:integration` passes against a migrated Postgres database
